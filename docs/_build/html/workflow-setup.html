
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>How to setup a full workflow (by example) &#8212; Kafka Topology Builder  documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Core Concepts" href="core-concepts.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="core-concepts.html" title="Core Concepts"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Kafka Topology Builder  documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="how-to-setup-a-full-workflow-by-example">
<h1>How to setup a full workflow (by example)<a class="headerlink" href="#how-to-setup-a-full-workflow-by-example" title="Permalink to this headline">¶</a></h1>
<p>This section describe the configuration steps need to setup a flow with the Kafka Topology Builder.
For this example we’re going to use:</p>
<ul class="simple">
<li>Github as the git server.</li>
<li>Jenkins as the CI/CD pipeline.</li>
</ul>
<p>Configuration is possible with other technologies such as Gitlab or Concourse for example.</p>
<a class="reference internal image-reference" href="_images/kafka-topology-builder.png"><img alt="Webhook events" class="align-center" src="_images/kafka-topology-builder.png" style="width: 400px;" /></a>
<div class="section" id="configure-the-git-server">
<h2>Configure the git server<a class="headerlink" href="#configure-the-git-server" title="Permalink to this headline">¶</a></h2>
<p>From the git server perspective you are going to need to setup the next steps:</p>
<ul class="simple">
<li>Block the master branch to push commits, so everyone is required to perform changes using a pull request.</li>
<li>Configure a webhook to inform the CI/CD pipeline every time:
* A pull request is created or changed.
* A merge happened to the master branch.</li>
</ul>
<p>For Github the webhook events to be selected are:</p>
<ul class="simple">
<li><em>Pull requests</em>: _Pull request opened, closed, reopened, edited, assigned, unassigned, review requested, review request removed, labeled, unlabeled, synchronized, ready for review, converted to draft, locked, or unlocked._</li>
<li>push event.</li>
</ul>
<p>it should look like this:</p>
<a class="reference internal image-reference" href="_images/webhook.png"><img alt="Webhook events" class="align-center" src="_images/webhook.png" style="width: 400px;" /></a>
</div>
<div class="section" id="setup-ci-cd">
<h2>Setup CI/CD<a class="headerlink" href="#setup-ci-cd" title="Permalink to this headline">¶</a></h2>
<p>As mentioned earlier the specific setup for the CI/CD pipeline will vary. In this documentation we will enumerate a few of the steps necessary if you are using Jenkins.</p>
<div class="section" id="how-many-pipelines-jobs-do-we-need">
<h3>How many pipelines/jobs do we need?<a class="headerlink" href="#how-many-pipelines-jobs-do-we-need" title="Permalink to this headline">¶</a></h3>
<p>The first question is how many pipelines do you need? we recommend having two:</p>
<ul class="simple">
<li>The first dedicated to do change request (pull request) verifications</li>
<li>A second one where we apply teh changes after merged</li>
</ul>
</div>
<div class="section" id="setting-up-the-pr-verification-pipeline">
<h3>Setting up the PR verification pipeline<a class="headerlink" href="#setting-up-the-pr-verification-pipeline" title="Permalink to this headline">¶</a></h3>
<p>The pipeline responsible of running the test for each change request should look like this:</p>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span> pipeline {

    agent {
     docker { image &#39;purbon/kafka-topology-builder:latest&#39; }
    }

    stages {
        stage(&#39;verify-replication-factor&#39;) {
            steps {
                sh &#39;checks/verify-replication-factor.sh ${TopologyFiles} 3&#39;
            }
        }
        stage(&#39;verify-num-of-partitions&#39;) {
             steps {
                sh &#39;checks/verify-num-of-partitions.sh ${TopologyFiles} 12&#39;
            }
        }
    }
 post {
    success {
        withCredentials([string(credentialsId: &#39;my-github&#39;, variable: &#39;GITHUB_TOKEN&#39;)]) {
            sh &#39;./post-hook-success.sh&#39;
        }
    }
    failure {
        withCredentials([string(credentialsId: &#39;my-github&#39;, variable: &#39;GITHUB_TOKEN&#39;)]) {
            sh &#39;./post-hook-failure.sh&#39;
        }
    }
 }
}
</pre></div>
</td></tr></table></div>
<p>In the previous pipeline definition, using the Jenkins Pipeline DSL, we can notice a few relevant steps:</p>
<ul class="simple">
<li>Is using docker as an agent. We suggest this as a best practise, but it is possible as well to run this with any agent available that has access to a host where the Kafka Topology Builder is installed.</li>
<li>There are a few verification, or test, steps. This are checks that run automatically for every Pull Request.</li>
<li>In the pipeline the reader can see the topology files are passes as jenkins parameters, see <em>${TopologyFiles}</em></li>
<li>An important post step is configured where the pipeline will inform back to the git server the result of the verification. This step needs access to each server token, for the case of this pipeline a previosly configured github token.</li>
</ul>
</div>
<div class="section" id="setting-up-the-main-pipeline">
<h3>Setting up the main pipeline<a class="headerlink" href="#setting-up-the-main-pipeline" title="Permalink to this headline">¶</a></h3>
<p>The main pipeline should look like this:</p>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span>pipeline {

    agent {
        docker { image &#39;purbon/kafka-topology-builder:latest&#39; }
    }

    stage(&#39;run&#39;) {
      steps {
          withCredentials([usernamePassword(credentialsId: &#39;confluent-cloud &#39;,
           usernameVariable: &#39;CLUSTER_API_KEY&#39;, passwordVariable: &#39;CLUSTER_API_SECRET&#39;)]) {
            sh &#39;./demo/build-connection-file.sh &gt; topology-builder.properties&#39;
          }
          sh &#39;kafka-topology-builder.sh  --brokers ${Brokers}
          --clientConfig topology-builder.properties --topology ${TopologyFiles}&#39;
        }
      }
    }
}
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="using-it-in-the-day-to-day">
<h2>Using it in the day to day<a class="headerlink" href="#using-it-in-the-day-to-day" title="Permalink to this headline">¶</a></h2>
<p>TBA</p>
</div>
<div class="section" id="taking-advantage-of-the-kafka-topology-builder-across-environments">
<h2>Taking advantage of the Kafka topology Builder across environments<a class="headerlink" href="#taking-advantage-of-the-kafka-topology-builder-across-environments" title="Permalink to this headline">¶</a></h2>
<p>TBA</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to setup a full workflow (by example)</a><ul>
<li><a class="reference internal" href="#configure-the-git-server">Configure the git server</a></li>
<li><a class="reference internal" href="#setup-ci-cd">Setup CI/CD</a><ul>
<li><a class="reference internal" href="#how-many-pipelines-jobs-do-we-need">How many pipelines/jobs do we need?</a></li>
<li><a class="reference internal" href="#setting-up-the-pr-verification-pipeline">Setting up the PR verification pipeline</a></li>
<li><a class="reference internal" href="#setting-up-the-main-pipeline">Setting up the main pipeline</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-it-in-the-day-to-day">Using it in the day to day</a></li>
<li><a class="reference internal" href="#taking-advantage-of-the-kafka-topology-builder-across-environments">Taking advantage of the Kafka topology Builder across environments</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="core-concepts.html"
                        title="previous chapter">Core Concepts</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/workflow-setup.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="core-concepts.html" title="Core Concepts"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Kafka Topology Builder  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Pere Urbon-Bayes.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>